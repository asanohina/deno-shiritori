<!DOCTYPE html>
<html lang="ja">

<head>
  <!-- headタグの中にはメタデータ等を記載する -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>しりとりゲーム</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <!-- bodyタグの中には実際に表示するものなどを書く -->
  <h1>しりとり</h1>
  <!-- 現在の単語を表示する場所 -->
  <p id="previousWord"></p>
  <!-- 次の文字を入力するフォーム -->
  <input id="nextWordInput" type="text" placeholder="次の単語を入力" />
  <button id="nextWordSendButton">送信</button>
  <button id="resetButton">リセット</button>

  <h2>しりとり履歴</h2>
  <ul id="historyList"></ul>

  <!-- JavaScriptを実行 -->
  <script>
    async function updateHistory() {
      const response = await fetch("/history");
      if (response.status === 200) {
        const data = await response.json();
        const historyList = document.querySelector("#historyList");
        historyList.innerHTML = ""; // 既存のリストをクリア

        for (const word of data.history) {
          const li = document.createElement("li");
          li.textContent = word;
          historyList.appendChild(li);
        }
      }
    }

    // 送信ボタン押下時の処理
    async function sendWord() {
      const nextWordInput = document.querySelector("#nextWordInput");
      const nextWordInputText = nextWordInput.value.trim();

      if (!nextWordInputText) {
        alert("単語を入力してください。");
        return;
      }

      // タイムアウトを設定するAbortsController
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒でタイムアウト

      try {
        const response = await fetch("/shiritori", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nextWord: nextWordInputText }),
          signal: controller.signal // タイムアウトシグナルを渡す
        });

        clearTimeout(timeoutId); // 成功したらタイムアウトをクリア

        if (response.status !== 200) {
          const errorJson = await response.json();
          alert(errorJson["errorMessage"]);
        } else {
          const result = await response.json();
          const paragraph = document.querySelector("#previousWord");
          paragraph.innerHTML = `前の単語: ${result.previousWord}`;
          nextWordInput.value = "";  // 入力フィールドをクリア

          if (result.gameOver === true) {
            // ゲームオーバーの場合、入力フォームと送信ボタンを削除
            document.querySelector("#nextWordInput").remove();
            document.querySelector("#nextWordSendButton").remove();
            alert(result.message);  // ゲームオーバーメッセージを表示
          }
          await updateHistory();  // 履歴を更新
        }
      } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
          alert("リクエストがタイムアウトしました。ネットワーク接続を確認してください。");
        } else {
          alert(`通信エラーが発生しました: ${error.message}`);
        }
        console.error("Fetch error:", error);
      }
    }

    window.onload = async () => {
      const paragraph = document.querySelector("#previousWord");
      try {
        const response = await fetch("/shiritori", { method: "GET" });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        const previousWord = data.lastWord || "しりとり";
        paragraph.innerHTML = `前の単語: ${previousWord}`;

      } catch (error) {
        console.error("初期単語の取得に失敗しました:", error);
        paragraph.innerHTML = "初期単語の読み込みに失敗しました。"; // エラー表示
      }

      await updateHistory();
      document.querySelector("#nextWordSendButton").onclick = sendWord;
    };

    // リセットボタンの押下時に実行
    document.querySelector("#resetButton").onclick = async (event) => {
      const response = await fetch(
        "/reset",
        {
          method: "POST",
        }
      );

      // status: 200以外が返ってきた場合にエラーを表示
      if (response.status === 200) {
        const result = await response.json();
        const paragraph = document.querySelector("#previousWord");
        paragraph.innerHTML = `前の単語: ${result.previousWord}`;
        alert(result.message);

        await updateHistory();

        // 入力フォームと送信ボタンがなければ再追加
        if (!document.querySelector("#nextWordInput")) {
          const input = document.createElement("input");
          input.id = "nextWordInput";
          input.type = "text";
          const sendButton = document.createElement("button");
          sendButton.id = "nextWordSendButton";
          sendButton.textContent = "送信";
          sendButton.onclick = sendWord;

          const resetButton = document.querySelector("#resetButton");
          document.body.insertBefore(input, resetButton);
          document.body.insertBefore(sendButton, resetButton);
        }

      } else {
        alert("リセットに失敗しました。");
      }
    };
  </script>

  <script src="/moji-master/dist/moji.js"></script>

</body>

</html>